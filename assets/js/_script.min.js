$(function() {
    smoothScroll();
    // accordionMenu();
    mobileNavMenu();
    // selectCustom();
    aosRun();
    // testimonialSlider();
    // testimonalTextExpand();
    // poductHomeSlider();
    // newsHomeSlider();
    mobileMenu();
    textSplittEffect();
        // slideNav(); Перенес в common
        // toTopButton(); Перенес в common
        // modalFormValidate(); Перенес в common
    // phoneMask();
        // countryMask(); Перенес в common
    // articleToggle();
    // metaIconsToggle();
    productSlider();
    // addToFavoritToggle();
    // archiveTabsToggle();
    favoritTabsToggle();
    phonesDropdown();
        // moadalsInit(); Перенес в common

    intersectionObserverApi(".testimonial", testimonialSlider);
    intersectionObserverApi(".testimonial", testimonalTextExpand);
    intersectionObserverApi(".map-holder", googleMap);
    intersectionObserverApi("select", selectCustom);
    intersectionObserverApi(".product-slider", poductHomeSlider);
    intersectionObserverApi(".news-slider", newsHomeSlider);
    // intersectionObserverApi('.image-slider__main', productSlider);
    intersectionObserverApi(".meta-favorits", metaIconsToggle);
    intersectionObserverApi(".article__content", articleToggle);
    intersectionObserverApi(".coop-video__inner", aboutUsVideo);
    // intersectionObserverApi(".send-form__input_phone", countryMask);

    /**
     *
     */
    videoClick();
    // modalContent(); Перенес в common в modlasInit
    addJivoSite();
    // iframeRatio(); Перенес в common
    // aboutUsVideo();
}); // Select Custom

// iFrame TextEditor Auto Height
/////////////////////////////////////
const iframeRatio = () => {

    $('.article-content iframe').parent().addClass('responsive-iframe');

}

const intersectionObserverApi = (selector, method) => {
    const arr = document.querySelectorAll(selector);
    if ("IntersectionObserver" in window) {
        const intersection = new IntersectionObserver((data, lazyobserver) => {
            data.forEach(entry => {
                if (entry.isIntersecting) {
                    method();
                    lazyobserver.unobserve(document.querySelector(selector));
                }
            });
        });

        arr.forEach(v => {
            intersection.observe(v);
        });
    } else {
        method();
    }
};

const selectCustom = () => {
    $("select").niceSelect();
}; // AOS Aniation

const aosRun = () => {

    if(window.AOS != undefined){
        AOS.init({
            disable: "phone",
            offset: 140,
            duration: 800,
            once: true
        });
    }

}; // Testimonial Slider -

const testimonialSlider = () => {
    // lazyLoadIframe();
    testimonialsSlider = new Swiper(".testimonial__slider", {
        loop: false,
        speed: 1000,
        slidesPerView: "auto",
        autoHeight: true,
        threshold: 10,
        grabCursor: true,
        spaceBetween: 200,
        pagination: {
            el: ".testimonial__pagination",
            clickable: true
        },
        navigation: {
            nextEl: ".testimonial__button-next",
            prevEl: ".testimonial__button-prev"
        }
    });
}; // Testimonial Text Readmore

const testimonalTextExpand = () => {
    let showChar = 330;
    let ellipsestext = "...";
    let moretext = siteText['global_read_full_1'];
    let lesstext = siteText['global_hide_text_1'];

    $(".testimonial__massage").each(function() {
        let content = $(this).html();

        if (content.length > showChar) {
            let c = content.substr(0, showChar);
            let h = content.substr(showChar, content.length - showChar);
            let html = `${c} <span class="moreellipses"> ${ellipsestext} &nbsp;</span><span class="morecontent"><span class="testimonial__expanded-text"> ${h} </span>&nbsp;&nbsp;<div class="testimonial__readmore-link link"> ${moretext} </div></span>`;
            $(this).html(html);
        }
    });
    $(".testimonial__readmore-link").click(function() {
        if ($(this).hasClass("less")) {
            $(this).removeClass("less");
            $(this).html(moretext);
        } else {
            $(this).addClass("less");
            $(this).html(lesstext);
        }

        $(this)
            .parent()
            .prev()
            .toggle();
        $(this)
            .prev()
            .toggle();
        testimonialsSlider.updateAutoHeight(400);
        return false;
    });

}; // Product Home Page Slider

const poductHomeSlider = () => {
    let breakpoint = window.matchMedia("(min-width:992px)");
    let prodSlider;

    let breakpointChecker = function() {
        if (breakpoint.matches === true) {
            if (prodSlider !== undefined) prodSlider.destroy(true, true);
            return;
        } else if (breakpoint.matches === false) {
            return enableSlider();
        }
    };

    const enableSlider = function() {
        prodSlider = new Swiper(".product-slider", {
            loop: true,
            speed: 1000,
            slidesPerView: "auto",
            pagination: {
                el: ".product-slider__pagination",
                clickable: true
            }
        });
    };

    breakpoint.addListener(breakpointChecker);
    breakpointChecker();
}; // News Home Page Slider

const newsHomeSlider = () => {
    let breakpoint = window.matchMedia("(min-width:1199px)");
    let newsSlider;

    let breakpointChecker = function() {
        if (breakpoint.matches === true) {
            if (newsSlider !== undefined) newsSlider.destroy(true, true);
            return;
        } else if (breakpoint.matches === false) {
            return enableSlider();
        }
    };

    const enableSlider = function() {
        newsSlider = new Swiper(".news-slider", {
            loop: true,
            speed: 1000,
            slidesPerView: "auto",
            pagination: {
                el: ".news-slider__pagination",
                clickable: true
            },
            breakpoints: {
                320: {
                    slidesPerView: 1,
                    spaceBetweenSlides: 40
                },
                700: {
                    slidesPerView: 2,
                    spaceBetweenSlides: 30
                }
            }
        });
    };

    breakpoint.addListener(breakpointChecker);
    breakpointChecker();
}; 

// Mobile Menu
const mobileMenu = () => {
    let menuBtn = document.querySelector(".hamburger");
    let sidenav = document.querySelector(".sidenav");

    menuBtn.onclick = function() {
        if (sidenav.classList.contains("sidenav_disabled")) {
            sidenav.classList.remove("sidenav_disabled");
            menuBtn.classList.add("hamburger_closed");
        } else {
            sidenav.classList.add("sidenav_disabled");
            menuBtn.classList.remove("hamburger_closed");
        }
    };
}; 

// Mobile Accordion Menu
const mobileNavMenu = () => {
    let AccordionMenu = function(selector) {
        this.colMenu = document.querySelectorAll(`${selector} li`);
        let This = this;
        this.colMenu.forEach(function(items) {
            if (items.querySelector('ul')) {
                items.firstElementChild.classList.add('has-dropdown');
                // items.firstElementChild.insertAdjacentHTML('beforeend', '<svg class="mobile-menu__icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 451.847 451.847" xml:space="preserve"> <g> <path d="M225.923,354.706c-8.098,0-16.195-3.092-22.369-9.263L9.27,151.157c-12.359-12.359-12.359-32.397,0-44.751 c12.354-12.354,32.388-12.354,44.748,0l171.905,171.915l171.906-171.909c12.359-12.354,32.391-12.354,44.744,0 c12.365,12.354,12.365,32.392,0,44.751L248.292,345.449C242.115,351.621,234.018,354.706,225.923,354.706z"/> </g> </svg>');

                items.firstElementChild.onclick = function(e) {
                    e.preventDefault();

                    let isTrue = this.parentElement.classList.toggle('open');

                    if (isTrue) {
                        This.show(this.nextElementSibling);
                    } else {
                        This.hide(this.nextElementSibling);
                    }
                };
            }
        });
    };

    // Show an element
    AccordionMenu.prototype.show = function(elem) {
        // Get the natural height of the element
        var getHeight = function() {
            elem.style.display = 'block'; // Make it visible
            var height = elem.scrollHeight + 'px'; // Get it's height
            return height;
        };

        var height = getHeight(); // Get the natural height
        elem.style.height = height; // Update the height

        setTimeout(function() {
            elem.style.height = 'auto';
        }, 350);
    };

    // Hide an element
    AccordionMenu.prototype.hide = function(elem) {
        // Give the element a height to change from
        elem.style.height = elem.scrollHeight + 'px';

        // Set the height back to 0
        setTimeout(function() {
            elem.style.height = '0';
        }, 110);

        setTimeout(function() {
            elem.style.display = '';
        }, 700);
    };

    new AccordionMenu('.mobile-nav');
};

// Title Text Fade + Splitt Effect
const textSplittEffect = () => {
    const breakpoint = window.matchMedia("(min-width:1025px)");

    const breakpointChecker = function() {
        if (breakpoint.matches === true) {
            Splitting();
            ScrollOut({
                // threshold: 0.3,
                once: true
            });
        } else if (breakpoint.matches === false) {
            ScrollOut({
                // threshold: 0.3,
                once: true
            }).teardown();
        }
    };

    breakpoint.addListener(breakpointChecker);
    breakpointChecker();
}; // Nav Menu Fixed + Slide Down

const slideNav = () => {
    let didScroll;
    let lastScrollTop = 0;
    let delta = 50;
    let navbarHeight = $(".header").outerHeight();
    
    $(window).scroll(function(event) {
        didScroll = true;
    });

    setInterval(function() {
        if (didScroll) {
            hasScrolled();
            didScroll = false;
        }
    }, 250);

    function hasScrolled() {
        var st = $(this).scrollTop();
        if (Math.abs(lastScrollTop - st) <= delta) return;

        if (st > lastScrollTop && st > navbarHeight) {
            $(".header")
                .removeClass("header_down")
                .addClass("header_up");
                
                if($(window).scrollTop() > 200) {

                    $(".header").addClass('header_black')
                } 
        } else {
            if (st + $(window).height() < $(document).height()) {
                $(".header")
                    .removeClass("header_up")
                    .addClass("header_down");

                if($(window).scrollTop() < 200) {

                    $(".header").removeClass('header_down').removeClass('header_black')
                } 
            }
        }

        lastScrollTop = st;
    }


}; // To Top Button

const moadalsInit = () => {

    if(window.innerWidth > 1200){
        $("[data-fancybox]").fancybox({
            autoFocus: false,
    
            beforeShow: function() {
                $('.header').css('padding-right', '17px');
                $('.to-top').addClass('compensate-for-scrollbar');
            },
            afterClose: function() {
                $('.header').css('padding-right', '0px');
                $('.to-top').removeClass('compensate-for-scrollbar');
            },
        });
    }
    
}

const toTopButton = () => {

    let scrollToTopButton = $(".to-top");
    $(window).scroll(function() {
        if ($(window).scrollTop() > 400) {
            scrollToTopButton.addClass("o-top_show");
            scrollToTopButton.removeClass("to-top_hide");
        } else {
            scrollToTopButton.removeClass("o-top_show");
            scrollToTopButton.addClass("to-top_hide");
        }
    });
    scrollToTopButton.on("click", function(e) {
        e.preventDefault();
        $("html, body").animate(
            {
                scrollTop: 0
            },
            1000
        );
    });
}; 

// Form Validation

const modalFormValidate = () => {
    $(".send-form_validate").validate({
        errorClass: "send-form__error",
        rules: {
            name: {
                required: true
            },
            phone: {
                required: true,
                minlength: 13,
                // minlength: 13,
            }
        },
        messages: {
            name: {
                required: siteText['validation_name']
            },
            phone: {
                required: siteText['validation_number'],
                minlength: siteText['validation_number_length']
            }
        }
    });
    $(".request__form").validate({
        errorClass: "send-form__error",
        rules: {
            name: {
                required: true
            },
            phone: {
                required: true,
                // minlength: 10
            }
        },
        messages: {
            name: {
                required: siteText['validation_name']
            },
            phone: {
                required: siteText['validation_number'],
                minlength: siteText['validation_number_length']
            }
        }
    });
}; 

// Form Phone Mask

const phoneMask = () => {
    let element = document.querySelectorAll(".send-form__input_phone");

    element.forEach( function(elem){
        let maskOptions = {
            mask: "+{00} 000 000 0000"
        };
        let mask = IMask(elem, maskOptions);
    });

};

const countryMask = () => {
    let input = document.querySelectorAll(".send-form__input_phone");
    let itiOptions = {};
    let maskOptions = {};

    itiOptions = {
        preferredCountries: ["tr","ua", "kz", "ru",],
        autoHideDialCode: false,
        nationalMode: true,
        autoPlaceholder: "aggressive",
        separateDialCode: true,
        initialCountry: "auto",
        geoIpLookup: function(success, failure) {
            $.get("https://ipinfo.io", function() {}, "jsonp").always(function(resp) {
            var countryCode = (resp && resp.country) ? resp.country : "";
            success(countryCode);
            });
        },

        customPlaceholder:function(selectedCountryPlaceholder, selectedCountryData){
            // return '+'+selectedCountryData.dialCode +' '+selectedCountryPlaceholder;
            return ''+selectedCountryPlaceholder;
        },


        utilsScript: "/site/js/utils.js"
    };


    maskOptions = {
        mask: '0000 000 00 00'
    };

    for(let i = 0; i < input.length; i++){

        let phoneMask;
        let iti = window.intlTelInput(input[i], itiOptions);
        phoneMask = IMask(input[i], maskOptions);

        input[i].addEventListener('focus', function(){
            let placeholder = this.placeholder;
            let minlength = placeholder.length;
            let newPhoneMask = placeholder.replace(/[0-9]/g,'0');
            let phoneNumber = placeholder.replace(/\s/g, '');
            let minNumbers = phoneNumber.length;

            $( this ).rules( "add", {
                minlength: minlength,
                messages: {
                    minlength: jQuery.validator.format("Пожалуйста, введите не меньше "+ minNumbers +" символов.")
                  }
            });

            phoneMask.mask = newPhoneMask
        })


        input[i].addEventListener('countrychange', function(){
            phoneMask.value = '';
        });
    };


}

// Article Toggle

const articleToggle = () => {
    let btn = document.querySelector(".article__toggle-btn");
    let content = document.querySelector(".article__content");

    if (btn) {
        btn.addEventListener("click", function() {
            if (content.classList.contains("article-content_toggle")) {
                content.classList.remove("article-content_toggle");
                btn.innerHTML = siteText['global_hide_text_2'];
            } else {
                content.classList.add("article-content_toggle");
                btn.innerHTML = siteText['global_read_full_2'];
            }
        });
    }
}; // Toggle Meta Icons

const metaIconsToggle = () => {
    // Meta Favorits
    let metaFavorit = document.querySelector(".meta-favorits");
    let metaFavoritIcon = document.querySelector(".to-favorits__icon");
    let tooltipFavorit = document.querySelector(".meta-favorits__tooltip");

    if (metaFavorit) {
        metaFavorit.addEventListener("click", function() {
            if (
                metaFavoritIcon.classList.contains("to-favorits__icon_active")
            ) {
                metaFavoritIcon.classList.remove("to-favorits__icon_active");
                tooltipFavorit.innerHTML =
                    tooltipFavorit.dataset.tooltipDelMassege;
            } else {
                metaFavoritIcon.classList.add("to-favorits__icon_active");
                tooltipFavorit.innerHTML =
                    tooltipFavorit.dataset.tooltipAddMassege;
            }
        });
    }
}; 

const productSlider = () => {
    // Params
    let mainSliderSelector = ".image-slider__main",
        navSliderSelector = ".image-slider__thumb",
        interleaveOffset = 0.5; // Main Slider

    let mainSliderOptions = {
        loop: true,
        speed: 1000,
        // autoplay:{
        //   delay:3000
        // },
        loopAdditionalSlides: 100,
        grabCursor: true,
        watchSlidesProgress: true,
        navigation: {
            nextEl: ".image-slider__button-next",
            prevEl: ".image-slider__button-prev"
        },

    };
    let mainSlider = new Swiper(mainSliderSelector, mainSliderOptions); // Navigation Slider

    let navSliderOptions = {
        loop: true,
        loopAdditionalSlides: 100,
        speed: 600,
        spaceBetween: 16,
        slidesPerView: 3,
        centeredSlides: true,
        touchRatio: 0.2,
        slideToClickedSlide: true,
        direction: "horizontal",
        breakpoints: {
            420: {
                slidesPerView: 4,
                spaceBetween: 16
            },
            767: {
                slidesPerView: 5,
                spaceBetween: 16
            },
            991: {
                spaceBetween: 30,
                slidesPerView: 5
            }
        }
    };
    let navSlider = new Swiper(navSliderSelector, navSliderOptions); // Matching sliders

    if (document.querySelector(".image-slider__main")) {
        mainSlider.controller.control = navSlider;
        navSlider.controller.control = mainSlider;
    }
}; 

// SmoothScroll

const smoothScroll = () => {
    SmoothScroll({
        stepSize: 60
    });
}; // Google Map Api

const googleMap = () => {
    let coor =
        typeof coordinates !== "undefined"
            ? coordinates
            : { lat: 36.544452, lng: 31.995427 };
    function initMap() {
        let popupContent = '<p class="marker_content">Address</p>',
            image = {
                url: "/site/images/icons/map_marker.svg" // size: new google.maps.Size(126, 40),
            },
            coordinates = coor,
            map = new google.maps.Map(document.querySelector(".map-holder"), {
                center: coordinates,
                zoom: 15,
                // disableDefaultUI: true,
                styles: [
                    {
                        featureType: "road",
                        elementType: "labels",
                        stylers: [
                            {
                                visibility: "off"
                            }
                        ]
                    },
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [
                            {
                                visibility: "off"
                            }
                        ]
                    },
                    {
                        featureType: "transit",
                        elementType: "labels.text",
                        stylers: [
                            {
                                visibility: "off"
                            }
                        ]
                    }
                ]
            }),
            marker = new google.maps.Marker({
                position: coordinates,
                map: map,
                icon: image,
                animation: google.maps.Animation.DROP
            }),
            infowindow = new google.maps.InfoWindow({
                content: popupContent
            });
        marker.addListener("click", function() {
            infowindow.open(map, marker);
        });
    }

    if (document.querySelector(".map-holder")) {
        initMap();
    }
}; 
// Toggle Catalog Add to Favorits

const addToFavoritToggle = () => {
    $(".card__to-favorits").click(function() {
        $(this)
            .children()
            .toggleClass("to-favorits__icon_active");
    });
}; // Archive tabs Toggle

const archiveTabsToggle = () => {
    $(".archive-tab").click(function() {
        let tabNum = $(this).attr("data-tab");
        $(".archive-tab").removeClass("archive-tab_active");
        $(".tab-content").removeClass("tab-content_current");
        $(this).addClass("archive-tab_active");
        $("." + tabNum).addClass("tab-content_current");
    });
}; // Favorit Page Tabs

const favoritTabsToggle = () => {
    $(".favorit-tabs__list-item").click(function() {
        let tabNum = $(this).attr("data-tab");
        $(".favorit-tabs__list-item").removeClass(
            "favorit-tabs__list-item_current"
        );
        $(".tab-content").removeClass("tab-content_current");
        $(this).addClass("favorit-tabs__list-item_current");
        $("." + tabNum).addClass("tab-content_current");
    });
}; 

// Image Popup

function videoClick() {
    $(".video__button").click(function() {
        var video = $(this).attr("data-video");
        $(".video-popup__content")
            .find("iframe")
            .remove();
        $("#openModalVideo")
            .find(".video-popup__content")
            .append(
                `<iframe class="video-popup__iframe" src="https://www.youtube.com/embed/` +
                    video +
                    `" frameborder="0"
      allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen></iframe>`
            );
    });
}

function modalContent() {
    $('.button[data-modal="true"]').click(function() {
        $title = $(this).attr("data-popup-title");
        $text = $(this).attr("data-popup-text");
        if ($title != "") {
            $(".popup__title").html($title);
        }
        if ($text != "") {
            $(".popup__text").html($text);
        }
    });
}

function aboutUsVideo() {
    $(".coop-video__inner").html(
        '<iframe width="100%" height="530" src="https://www.youtube.com/embed/' +
            video +
            '" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>'
    );
}

// Phones Slide Menu
const phonesDropdown = () => {
    $(document).on("click", ".phone-dropdown", function() {
        $(this).toggleClass('phone-dropdown_opened')
        $('.offcanvas-phones').toggleClass('offcanvas-phones_open');
    });
};

function addJivoSite(){
    if(document.documentElement.lang == 'ru'){
        setTimeout(function(){
            $('script[name="jivo"]').attr('src', '//code.jivosite.com/widget.js').attr('data-jv-id', 'sQBQbXkCQA');
        }, 5000);
    }
    else{
        setTimeout(function(){
            $('script[name="jivo"]').attr('src', '//code.jivosite.com/widget.js').attr('data-jv-id', '2hFA7tofpd');
        }, 5000);
    }

}
